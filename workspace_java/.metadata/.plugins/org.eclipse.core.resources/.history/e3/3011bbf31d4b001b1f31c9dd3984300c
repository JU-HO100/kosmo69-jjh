package com.example.demo;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/*
 * AOP 프레임 워크를 활용하여 트랜잭셕 처리하는 구간임. 
 */
@Service
public class BoardLogic {
   Logger logger = LogManager.getLogger(BoardLogic.class);
   
   //false일때는 해당 클래스가 없어도 에러가 아니지만 true일땐 필수이니까 에러 발생한다.
   @Autowired(required=false)
   private SqlBoardMDao sqlBoardMDao= null;
   
   @Autowired(required=false)
   private SqlBoardDDao sqlBoardDDao= null;
   
   public int boardInsert(Map<String, Object> pMap) {
      logger.info("boardInsert 호출 성공"+pMap);
      int bm_no = 0;
      int bm_group = 0;
      if(pMap.get("bm_group")!=null) {
         bm_group = Integer.parseInt(pMap.get("bm_group").toString());
      }
      //글번호 채번한 결과를 파라미터에 저장
      bm_no = sqlBoardMDao.getBmno();
      pMap.put("bm_no",bm_no);
      //너 댓글이니?
      if(bm_group > 0) {
         pMap.put("bm_group",bm_group);
         sqlBoardMDao.bmStepUpdate(pMap);
         int pos = 0;
         int step = 0;
         if(pMap.get("bm_pos") !=null) {
            pos = Integer.parseInt(pMap.get("bm_pos").toString());
         }
         pMap.put("bm_pos", pos+1);
         if(pMap.get("bm_step") !=null) {
            step = Integer.parseInt(pMap.get("bm_step").toString());
         }
         pMap.put("bm_step", step+1);
      }
      //너 새글이야?
      else { 
         bm_group = sqlBoardMDao.getBmGroup();
         pMap.put("bm_group", bm_group);
         pMap.put("bm_pos", 0);
         pMap.put("bm_step", 0);
      }
      int mresult = sqlBoardMDao.boardMInsert(pMap);
      //첨부파일이 있니?
      if(pMap.get("bs_file")!=null && pMap.get("bs_file").toString().length() > 1) {
         pMap.put("bm_no",bm_no);
         pMap.put("bs_seq",1);
         mresult = sqlBoardDDao.boardDInsert(pMap);
      }
      return mresult;
   }
   
   public List<Map<String, Object>> boardList(Map<String, Object> pMap) {
      logger.info("boardList 호출 성공"+pMap);
      List<Map<String, Object>> bList = new ArrayList<>();
      bList = sqlBoardMDao.boardList(pMap);
      return bList;
   }

}