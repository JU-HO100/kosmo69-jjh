<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>카카오 로그인</title>
<script src="https://developers.kakao.com/sdk/js/kakao.min.js"></script>
<script type="text/javascript" src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
</head>
<body>
<!-- =============================== 카카오 로그인 ================================================== -->
<div id="kakao-login-btn"></div>
<script type='text/javascript'>
// routes/auth/kakao.js
   /**
    * @summary 사용자 계정을 provider 로 연동. 인증 정보와 함께 저장
    *
    * @param {*} session 사용자 세션
    * @param {*} provider 공급사
    * @param {*} authData 인증 정보
    */
   function linkUser(session, provider, authData) {
     let result = false;
     if (session.authData) {
       if (session.authData[provider]) {
         // 이미 계정에 provider 가 연결되어 있는 경우
         return result;
       }

       session.authData[provider] = authData;
     } else {
       session.authData = {
         [provider]: authData
       };
     }

     result = true;

     return result;
   }

   /**
    * 
    * @summary '사용자 서비스 동의' 완료 후, 이동되는 주소.
    *
    * @description
    * - 사용자로부터 동의를 구한 후, 서비스 내에서 처리할 로직을 구현합니다.
    */

 	// http://localhost:8888/auth/kakao/callback
   	router.get("http://localhost:9000/auth/kakao/callback", async (req, res) {
     const { session, query } = req;
     const { code } = query;

     console.info("==== session ====");
     console.log(session);

     let tokenResponse;
     try {
       // Authorization Server 부터 Access token 발급받기
       tokenResponse = await axios({
         method: "POST",
         url: 'https://kauth.kakao.com/oauth/token',
         headers: {
           "content-type": "application/x-www-form-urlencoded"
         },
         data: qs.stringify({
           grant_type: "authorization_code",
           client_id: 'f61c36ee28b1fe4d00e270bcf75d344d',
           client_secret: LFtOmxJX0vZ7CyY2QPwkWjZTqu3CCZbt,
           redirect_uri: 'http://192.168.0.38:9000/member/index.jsp',
           code
         })
       });
     } catch (error) {
       return res.json(error.data);
     }

     console.info("==== tokenResponse.data ====");
     console.log(tokenResponse.data);

     const { access_token } = tokenResponse.data;

     let userResponse;
     try {
       // access_token 으로 사용자 정보 요청하기
       userResponse = await axios({
         method: "GET",
         url: "https://kapi.kakao.com/v2/user/me",
         headers: {
           Authorization: `Bearer ${access_token}`
         }
       });
     } catch (error) {
       return res.json(error.data);
     }

     console.info("==== userResponse.data ====");
     console.log(userResponse.data);

     const authData = {
       ...tokenResponse.data,
       ...userResponse.data
     };

     const result = linkUser(session, "kakao", authData);

     if (result) {
       console.info("계정에 연결되었습니다.");
     } else {
       console.warn("이미 연결된 계정입니다.");
     }

     res.redirect("/");
   });
</script>
<!-- =============================== 카카오 로그인 ================================================== -->


</body>
</html>